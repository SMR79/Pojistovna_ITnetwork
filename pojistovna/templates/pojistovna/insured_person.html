{% extends "main.html" %}
{% block content %}

<div>
    {% if user.is_authenticated %}
        <h3>Registr poji≈°tƒõnc≈Ø</h3>    
        {% if page_obj %}            
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Jm√©no</th>
                        <th>P≈ô√≠jmen√≠</th>
                        <th>Email</th>
                        <th>Telefon</th>
                        <th>Poƒçet poji≈°tƒõn√≠</th>
                        <th>Registrace u≈æivatele</th>
                        <th>Akce</th>
                    </tr>
                </thead>
                <tbody id="insuredTableBody">
                    {% include "pojistovna/insured_person_table_rows.html" %}
                </tbody>
            </table>            
        {% else %}
            <p>≈Ω√°dn√≠ poji≈°tƒõnci nejsou evidov√°ni.</p>
        {% endif %}
    {% else %}
        <h2>üßë‚Äçü§ù‚Äçüßë Poji≈°tƒõnci</h2>
        <p>Poji≈°tƒõnec je fyzick√° osoba, kter√° je zaregistrov√°na v syst√©mu a m≈Ø≈æe vyu≈æ√≠vat poji≈°≈•ovac√≠ch slu≈æeb. V t√©to sekci naleznete seznam v≈°ech evidovan√Ωch poji≈°tƒõnc≈Ø spolu s jejich osobn√≠mi √∫daji, jako je jm√©no, adresa, datum narozen√≠ nebo kontakt.</p>
        <p>Ka≈æd√©mu poji≈°tƒõnci lze p≈ôi≈ôadit jedno ƒçi v√≠ce poji≈°tƒõn√≠ podle jeho pot≈ôeb a ≈æivotn√≠ situace. Syst√©m umo≈æ≈àuje snadnou spr√°vu √∫daj≈Ø, p≈ôehledn√© zobrazen√≠ historie pojistn√Ωch ud√°lost√≠ a propojen√≠ s aktivn√≠mi pojistn√Ωmi smlouvami.</p>
        <p>Tato sekce je kl√≠ƒçov√° pro spr√°vu datab√°ze klient≈Ø a sledov√°n√≠ jejich poji≈°≈•ovac√≠ho vztahu s instituc√≠.</p>
    {% endif %}
</div>

{% endblock %}


{% block sidebar %}
    <ul>
        <li class="dropdown">
            <a id="dropdownSearch" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-search fs-3"></i>
            </a>
            <ul class="dropdown-menu p-3" style="min-width: 250px; left: 0 !important;">
                <input type="text" class="form-control" id="searchSurname" name="surname" placeholder="P≈ô√≠jmen√≠">
                <input type="text" class="form-control mb-2" id="searchName" name="name" placeholder="Jm√©no">                
            </ul>
        </li>

        <li><a href="{% url 'pojistovna:insured_person_form' %}" class="btn btn-outline-secondary" title="P≈ôidat poji≈°tƒõnce"><i class="bi bi-person-fill-add fs-3"></i></a></li>
        <li><a href="{% url 'pojistovna:home' %}" class="btn btn-outline-secondary" title="Zpƒõt dom≈Ø"><i class="bi bi-arrow-left fs-3"></i></a></li>
    </ul>
{% endblock %}


{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
    const nameInput = document.getElementById("searchName");
    const surnameInput = document.getElementById("searchSurname");
    const tbody = document.getElementById("insuredTableBody");

    let debounceTimer = null;

    function updateResults(name, surname, page = 1) {
        const query = `name=${encodeURIComponent(name)}&surname=${encodeURIComponent(surname)}&page=${page}`;

        fetch(`/insured_person/search/?${query}`)
            .then(response => response.text())
            .then(html => {
                tbody.innerHTML = html;
            });
    }

    function onInputChange() {
        const name = nameInput.value.trim();
        const surname = surnameInput.value.trim();

        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => updateResults(name, surname), 300);  // debounce 300ms
    }

    nameInput.addEventListener("input", onInputChange);
    surnameInput.addEventListener("input", onInputChange);

    // Dynamick√° paginace se zachov√°n√≠m hodnot vstup≈Ø
    document.addEventListener("click", function (e) {
        if (e.target.matches(".page-link")) {
            e.preventDefault();

            const link = new URL(e.target.href, window.location.origin);
            const page = link.searchParams.get("page") || 1;
            const name = nameInput.value.trim();
            const surname = surnameInput.value.trim();

            updateResults(name, surname, page);
        }
    });
});
</script>
{% endblock %}